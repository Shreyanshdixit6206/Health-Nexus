<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Health NEXUS - Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.0/dist/vanilla-tilt.min.js"></script>
  <style>
    .fade { animation: fadeIn .28s ease both }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    /* Mobile modal and touch improvements */
    @media (max-width: 640px) {
      .modal-mobile { inset: 0; position: fixed; display: flex; align-items: stretch; justify-content: center; }
      .modal-mobile > .bg-white { width: 100% !important; height: 100% !important; border-radius: 0 !important; margin: 0 !important; overflow:auto !important; }
      button { min-height: 44px; padding-top: .6rem; padding-bottom: .6rem; }
      #store-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="bg-white shadow p-4 sticky top-0 z-50">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/1200px-Emblem_of_India.svg.png" alt="logo" class="w-10 h-10 opacity-80" />
        <h1 class="text-xl font-bold">Health NEXUS</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="nav-store" class="px-4 py-2 rounded bg-amber-400 hover:bg-amber-500 hidden" data-i18n="store">Store</button>
        <button id="nav-vault" class="px-4 py-2 rounded bg-slate-100 hover:bg-slate-200 hidden" data-i18n="vault">Vault</button>
        <button id="nav-orders" class="px-4 py-2 rounded bg-slate-100 hover:bg-slate-200 hidden" data-i18n="orders">Orders</button>
        <button id="login-nav" class="px-4 py-2 rounded bg-teal-600 text-white hidden" data-i18n="login">Login</button>
        <button id="logout-btn" class="px-4 py-2 rounded bg-red-600 text-white hidden" data-i18n="logout">Logout</button>
        <div class="ml-2 flex items-center gap-1">
          <button id="lang-en" class="px-2 py-1 rounded bg-slate-100">EN</button>
          <button id="lang-hi" class="px-2 py-1 rounded bg-slate-100">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        </div>
          <div id="user-location" class="ml-4 text-sm text-slate-500 hidden"></div>
      </div>
    </div>
  </header>

  <main class="container mx-auto p-6">
    <!-- LANDING PAGE -->
    <section id="landing" class="fade">
      <div class="text-center py-12 px-4">
        <h2 class="text-4xl sm:text-5xl font-extrabold text-slate-900 mb-4" data-i18n="landing_title">Your Trusted Digital Health Partner</h2>
        <p class="mt-2 text-lg text-slate-600 max-w-2xl mx-auto" data-i18n="landing_sub">Access affordable generic medicines, securely store your medical documents, and manage your health with ease.</p>
        <div class="mt-8 flex justify-center gap-4 flex-wrap">
          <button id="cta-login" class="px-8 py-3 bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-full font-semibold hover:shadow-lg transition" data-i18n="get_started">Get Started</button>
          <button id="cta-learn" class="px-8 py-3 bg-white border-2 border-slate-300 rounded-full font-semibold hover:bg-slate-50 transition" data-i18n="learn_more">Learn More</button>
        </div>
        <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition">
            <img src="https://etimg.etb2bimg.com/photo/82181938.cms" class="w-full h-48 object-cover rounded-lg mb-4" alt="Generic Medicines">
            <h3 class="font-bold text-xl mb-2">Affordable Generic Medicines</h3>
            <p class="text-slate-600" data-i18n="benefit1_desc">Save up to 80% on authentic generic medicines from trusted suppliers. No compromises on quality.</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition">
            <img src="https://www.shutterstock.com/image-photo/data-security-protection-privacy-on-600nw-2377224243.jpg" class="w-full h-48 object-cover rounded-lg mb-4" alt="Secure Vault">
            <h3 class="font-bold text-xl mb-2">Secure Medical Vault</h3>
            <p class="text-slate-600" data-i18n="benefit2_desc">Store all your medical records, prescriptions, and documents in one secure, encrypted location.</p>
          </div>
          <div class="p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition">
            <div class="w-full h-48 rounded-lg mb-4 bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center overflow-hidden">
              <img src="https://cdn.prod.website-files.com/5ef27cb65411b70949a151e9/61cd9500009471ec4096c045_Frame%208668.png" class="w-full h-full object-cover" alt="Order Tracking">
            </div>
            <h3 class="font-bold text-xl mb-2">Easy Order Tracking</h3>
            <p class="text-slate-600" data-i18n="benefit3_desc">Place orders in minutes and track your medicines with real-time delivery updates.</p>
          </div>
        </div>
      </div>
    </section>

  <!-- Mobile floating cart button -->
  <button id="mobile-cartBtn" class="sm:hidden fixed bottom-6 right-4 bg-teal-600 text-white p-4 rounded-full shadow-lg z-50">Cart (<span id="mobile-cart-count">0</span>)</button>

    <!-- MEDICINE STORE -->
    <section id="store" class="hidden">
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6 flex-col sm:flex-row sm:items-center gap-3">
          <div>
            <h3 class="text-3xl font-bold">Medicine Store</h3>
            <div id="nearest-kendra" class="text-sm text-slate-500 mt-1 hidden">Ordering by nearest Janaushadi Kendra</div>
          </div>
          <button id="view-cart-btn" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition">View Cart (<span id="cart-count">0</span>)</button>
        </div>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <div class="flex-1 relative">
            <input id="store-search" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-teal-600" placeholder="Search medicines or brand names..." autocomplete="off" />
            <div id="search-suggestions" class="absolute left-0 top-14 bg-white border border-slate-200 shadow-lg rounded-lg w-full max-h-64 overflow-auto hidden z-40"></div>
          </div>
          <button id="search-btn" class="px-6 py-3 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition whitespace-nowrap">üîç Search</button>
        </div>
      </div>
      <div id="store-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- VAULT -->
    <section id="vault" class="hidden">
      <h3 class="text-3xl font-bold mb-6">Health Vault</h3>
      
      <!-- ABHA Verification Status -->
      <div id="abha-verification-box" class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-bold text-lg text-blue-900">ABHA ID Verification Required</h4>
            <p class="text-sm text-blue-700 mt-1">Verify your ABHA ID to enable secure storage on government database.</p>
          </div>
          <button id="verify-abha-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition whitespace-nowrap">Verify ABHA ID</button>
        </div>
      </div>

      <!-- Upload Section (hidden until verified) -->
      <div id="upload-section" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
        <p class="text-slate-600 mb-4">‚úì ABHA Verified - Data will be securely saved on the government database.</p>
        <div class="flex flex-col sm:flex-row gap-4">
          <input id="doc-file" type="file" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg" />
          <button id="upload-doc" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition">Upload</button>
        </div>
      </div>
      
      <div id="vault-list" class="space-y-4"></div>
    </section>

    <!-- ORDERS -->
    <section id="orders" class="hidden">
      <h3 class="text-3xl font-bold mb-6" data-i18n="my_orders">My Orders</h3>
      <div id="orders-list" class="space-y-4"></div>
    </section>

    <!-- CART MODAL -->
    <div id="cart-modal" class="modal-mobile fixed inset-0 hidden flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-8 max-w-2xl w-full max-h-96 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-4">Shopping Cart</h2>
        <div id="cart-items-list" class="mb-4 space-y-3"></div>
        <div class="border-t pt-4 mb-4">
          <div class="flex justify-between text-lg font-bold">
            <span>Total:</span>
            <span>‚Çπ<span id="cart-total">0</span></span>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="continue-shopping" class="flex-1 px-4 py-2 bg-slate-300 rounded-lg font-semibold hover:bg-slate-400">Continue Shopping</button>
          <button id="checkout-btn" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700">Proceed to Checkout</button>
        </div>
      </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="modal-mobile fixed inset-0 hidden flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-8 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-6">Delivery Details</h2>
        <input id="checkout-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600 mb-3" placeholder="Full Name" />
        <input id="checkout-phone" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600 mb-3" placeholder="Phone (10 digits)" maxlength="10" />
        <textarea id="checkout-address" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600 mb-4" placeholder="Delivery Address" rows="3"></textarea>
        <div class="bg-slate-100 p-3 rounded-lg mb-4">
          <div class="flex justify-between text-sm mb-1"><span>Subtotal:</span><span>‚Çπ<span id="checkout-subtotal">0</span></span></div>
          <div class="flex justify-between text-sm mb-2"><span>Shipping:</span><span>Free</span></div>
          <div class="flex justify-between font-bold text-lg"><span>Total:</span><span>‚Çπ<span id="checkout-total">0</span></span></div>
        </div>
        <div class="flex gap-3">
          <button id="back-to-cart" class="flex-1 px-4 py-2 bg-slate-300 rounded-lg font-semibold hover:bg-slate-400">Back</button>
          <button id="proceed-payment" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700">Pay Now</button>
        </div>
      </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="modal-mobile fixed inset-0 hidden flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-8 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-6">Payment</h2>
        <div class="bg-gradient-to-r from-teal-500 to-teal-700 text-white p-4 rounded-lg mb-6">
          <div class="text-sm opacity-80">Amount to Pay</div>
          <div class="text-3xl font-bold">‚Çπ<span id="payment-amount">0</span></div>
        </div>
        <input id="card-number" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600 mb-3" placeholder="Card Number" maxlength="19" />
        <div class="flex gap-3 mb-3">
          <input id="card-expiry" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600" placeholder="MM/YY" maxlength="5" />
          <input id="card-cvv" class="w-20 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-teal-600" placeholder="CVV" maxlength="3" />
        </div>
        <div class="text-xs text-slate-500 mb-4 p-2 bg-slate-50 rounded">Demo: Any card works (e.g., 4111 1111 1111 1111)</div>
        <div class="flex gap-3">
          <button id="cancel-payment" class="flex-1 px-4 py-2 bg-slate-300 rounded-lg font-semibold hover:bg-slate-400">Cancel</button>
          <button id="pay-now" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Pay Now</button>
        </div>
      </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal-mobile fixed inset-0 hidden flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-8 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-6" data-i18n="login_modal_title">Login with Aadhaar (OTP)</h2>
        <div class="mt-4">
          <label class="block text-sm text-slate-600" data-i18n="aadhaar_label">Aadhaar Number</label>
          <input id="aadhaar-input" class="w-full mt-1 px-3 py-2 border rounded" placeholder="123412341234" />
        </div>
        <div id="otp-section" class="mt-4 hidden">
          <label class="block text-sm text-slate-600" data-i18n="enter_otp">Enter OTP</label>
          <input id="otp-input" class="w-full mt-1 px-3 py-2 border rounded" placeholder="6-digit OTP" />
        </div>
        <div class="mt-4 flex gap-2">
          <button id="request-otp" class="px-4 py-2 bg-amber-500 text-white rounded" data-i18n="request_otp">Request OTP</button>
          <button id="verify-otp" class="px-4 py-2 bg-teal-600 text-white rounded hidden" data-i18n="verify_otp">Verify OTP</button>
          <button id="close-login" class="ml-auto px-3 py-2 text-slate-600" data-i18n="close">Close</button>
        </div>
        <p id="login-help" class="mt-3 text-sm text-slate-500" data-i18n="login_help">OTP will be shown in server console (dev mode).</p>
      </div>
    </div>

    <!-- ABHA ID VERIFICATION MODAL -->
    <div id="abha-modal" class="modal-mobile fixed inset-0 hidden flex items-center justify-center z-50 bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-8 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-2">ABHA ID Verification</h2>
        <p class="text-sm text-slate-600 mb-6">Verify your ABHA ID to securely store medical records on the government database.</p>
        <div class="mt-4">
          <label class="block text-sm text-slate-600">ABHA ID (10 digits)</label>
          <input id="abha-input" class="w-full mt-1 px-3 py-2 border rounded focus:outline-none focus:border-teal-600" placeholder="1234567890" maxlength="10" />
        </div>
        <div class="mt-4 flex gap-2">
          <button id="verify-abha" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded font-semibold hover:bg-teal-700">Verify ABHA</button>
          <button id="close-abha" class="px-4 py-2 bg-slate-300 rounded font-semibold hover:bg-slate-400">Cancel</button>
        </div>
        <div id="abha-status" class="mt-4 text-sm hidden p-3 rounded-lg"></div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = '/api';
    const tokenKey = 'hn_token';

    // i18n translations
    const translations = {
      en: {
        store: 'Store', vault: 'Vault', orders: 'Orders', login: 'Login', logout: 'Logout',
        landing_title: 'Your Trusted Digital Health Partner',
        landing_sub: 'Access affordable generic medicines, securely store your medical documents, and manage your health with ease.',
        get_started: 'Get Started', learn_more: 'Learn More',
        benefit1_desc: 'Save up to 80% on authentic generic medicines from trusted suppliers. No compromises on quality.',
        benefit2_desc: 'Store all your medical records, prescriptions, and documents in one secure, encrypted location.',
        benefit3_desc: 'Place orders in minutes and track your medicines with real-time delivery updates.',
        login_modal_title: 'Login with Aadhaar (OTP)', aadhaar_label: 'Aadhaar Number', enter_otp: 'Enter OTP', request_otp: 'Request OTP', verify_otp: 'Verify OTP', close: 'Close', login_help: 'OTP will be shown in server console (dev mode).',
        my_orders: 'My Orders', added_to_cart: 'Add to Cart', enter_aadhaar: 'Enter Aadhaar', enter_aadhaar_otp: 'Enter aadhaar and otp', login_success: 'Login successful ‚Äî welcome '
      },
      hi: {
        store: '‡§∏‡•ç‡§ü‡•ã‡§∞', vault: '‡§µ‡•â‡§≤‡•ç‡§ü', orders: '‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏', login: '‡§≤‡•â‡§ó‡§ø‡§®', logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
        landing_title: '‡§Ü‡§™‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§æ‡§•‡•Ä',
        landing_sub: '‡§∏‡§∏‡•ç‡§§‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¶‡§µ‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡•á‡§Ç, ‡§Ö‡§™‡§®‡•á ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§∏‡§æ‡§®‡•Ä ‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡§∞‡•á‡§Ç‡•§',
        get_started: '‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç', learn_more: '‡§î‡§∞ ‡§ú‡§æ‡§®‡•á‡§Ç',
        benefit1_desc: '‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§Ü‡§™‡•Ç‡§∞‡•ç‡§§‡§ø‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§∏‡•á ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¶‡§µ‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§™‡§∞ 80% ‡§§‡§ï ‡§¨‡§ö‡§æ‡§è‡§Ç‡•§ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§',
        benefit2_desc: '‡§Ö‡§™‡§®‡•á ‡§∏‡§≠‡•Ä ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°, ‡§™‡•ç‡§∞‡§ø‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§î‡§∞ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§è‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§∞‡§ñ‡•á‡§Ç‡•§',
        benefit3_desc: '‡§ï‡•Å‡§õ ‡§π‡•Ä ‡§Æ‡§ø‡§®‡§ü‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§∞‡•Ä‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
        login_modal_title: '‡§Ü‡§ß‡§æ‡§∞ ‡§∏‡•á ‡§≤‡•â‡§ó‡§ø‡§® (OTP)', aadhaar_label: '‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞', enter_otp: 'OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç', request_otp: 'OTP ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§∞‡•á‡§Ç', verify_otp: 'OTP ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç', close: '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç', login_help: 'OTP ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ (‡§°‡§ø‡§µ ‡§Æ‡•ã‡§°)‡•§',
        my_orders: '‡§Æ‡•á‡§∞‡•á ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏', added_to_cart: '‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç', enter_aadhaar: '‡§Ü‡§ß‡§æ‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç', enter_aadhaar_otp: '‡§Ü‡§ß‡§æ‡§∞ ‡§î‡§∞ OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç', login_success: '‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤ ‚Äî ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à '
      }
    };

    let currentLang = 'en';
    let isLoggedIn = false;
    let CART = [];
    let checkoutData = {};
    let abhaVerified = false;

    const brandToGenericMap = {
      'crocin': 'paracetamol', 'dolo': 'paracetamol', 'brufen': 'ibuprofen', 'ibugesic': 'ibuprofen',
      'ecosprin': 'aspirin', 'amoxil': 'amoxicillin', 'zithromax': 'azithromycin', 'cipro': 'ciprofloxacin',
      'glycomet': 'metformin', 'glucophage': 'metformin', 'amaryl': 'glimepiride', 'norvasc': 'amlodipine',
      'cozaar': 'losartan', 'zestril': 'lisinopril', 'lipitor': 'atorvastatin', 'crestor': 'rosuvastatin',
      'zocor': 'simvastatin', 'losec': 'omeprazole', 'prilosec': 'omeprazole', 'pantocid': 'pantoprazole',
      'lanzol': 'lansoprazole', 'eltroxin': 'levothyroxine', 'zoloft': 'sertraline', 'prozac': 'fluoxetine',
      'celexa': 'citalopram', 'lexapro': 'escitalopram', 'xanax': 'alprazolam', 'valium': 'diazepam',
      'klonopin': 'clonazepam', 'deltasone': 'prednisone', 'ventolin': 'salbutamol', 'singulair': 'montelukast',
      'zyrtec': 'cetirizine', 'claritin': 'loratadine', 'xyzal': 'levocetirizine', 'rhinocort': 'budesonide',
      'calcirol': 'vitamin d3', 'calpol': 'calcium carbonate', 'centrum': 'multivitamin'
    };

    function setLanguage(lang){
      currentLang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
      });
    }

    function updateLoginState(){
      const token = localStorage.getItem(tokenKey);
      isLoggedIn = !!token;
      const loginBtn = document.getElementById('login-nav');
      const logoutBtn = document.getElementById('logout-btn');
      const navStore = document.getElementById('nav-store');
      const navVault = document.getElementById('nav-vault');
      const navOrders = document.getElementById('nav-orders');
      if (isLoggedIn){
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        navStore.classList.remove('hidden');
        navVault.classList.remove('hidden');
        navOrders.classList.remove('hidden');
        loadCart();
      } else {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        navStore.classList.add('hidden');
        navVault.classList.add('hidden');
        navOrders.classList.add('hidden');
      }
    }

    function updateCartUI(){
      const count = document.querySelectorAll('#cart-count');
      count.forEach(el => el.textContent = CART.length);
      const mobileCount = document.getElementById('mobile-cart-count');
      if (mobileCount) mobileCount.textContent = CART.length;
      const total = CART.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
      const totalEls = document.querySelectorAll('#cart-total, #checkout-total, #checkout-subtotal, #payment-amount');
      totalEls.forEach(el => el.textContent = total);
    }

    function loadCart(){
      const saved = localStorage.getItem('hn_cart_full');
      CART = saved ? JSON.parse(saved) : [];
      updateCartUI();
    }

    function saveCart(){
      localStorage.setItem('hn_cart_full', JSON.stringify(CART));
      updateCartUI();
    }

    // ABHA Verification
    function checkAbhaStatus(){
      abhaVerified = localStorage.getItem('hn_abha_verified') === 'true';
      const verifyBox = document.getElementById('abha-verification-box');
      const uploadSection = document.getElementById('upload-section');
      if (abhaVerified){
        verifyBox.classList.add('hidden');
        uploadSection.classList.remove('hidden');
      } else {
        verifyBox.classList.remove('hidden');
        uploadSection.classList.add('hidden');
      }
    }

    document.getElementById('verify-abha-btn').addEventListener('click', () => {
      document.getElementById('abha-modal').classList.remove('hidden');
    });

    document.getElementById('close-abha').addEventListener('click', () => {
      document.getElementById('abha-modal').classList.add('hidden');
    });

    document.getElementById('verify-abha').addEventListener('click', async () => {
      const abhaId = document.getElementById('abha-input').value.trim();
      if (!abhaId || abhaId.length !== 10 || !/^\d+$/.test(abhaId)){
        alert('Please enter a valid 10-digit ABHA ID');
        return;
      }
      const statusEl = document.getElementById('abha-status');
      const verifyBtn = document.getElementById('verify-abha');
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';
      
      // Simulate verification delay
      await new Promise(r => setTimeout(r, 1500));
      
      // Mark as verified
      localStorage.setItem('hn_abha_verified', 'true');
      localStorage.setItem('hn_abha_id', abhaId);
      abhaVerified = true;
      
      statusEl.classList.remove('hidden');
      statusEl.className = 'mt-4 text-sm hidden p-3 rounded-lg bg-green-100 text-green-800 flex items-center gap-2';
      statusEl.innerHTML = '‚úì ABHA ID verified successfully! Your data will be securely saved on the government database.';
      
      setTimeout(() => {
        document.getElementById('abha-modal').classList.add('hidden');
        document.getElementById('abha-input').value = '';
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify ABHA';
        checkAbhaStatus();
      }, 2000);
    });    // Language buttons
    document.getElementById('lang-en').addEventListener('click', ()=> setLanguage('en'));
    document.getElementById('lang-hi').addEventListener('click', ()=> setLanguage('hi'));
    setLanguage('en');

    // Logout
    document.getElementById('logout-btn').addEventListener('click', ()=>{
      localStorage.removeItem(tokenKey);
      CART = [];
      localStorage.removeItem('hn_cart_full');
      updateCartUI();
      updateLoginState();
      document.getElementById('landing').classList.remove('hidden');
      ['store','vault','orders'].forEach(s => document.getElementById(s).classList.add('hidden'));
      alert('Logged out');
    });

    // Navigation
    document.getElementById('cta-login').addEventListener('click', () => showLogin());
    document.getElementById('login-nav').addEventListener('click', () => showLogin());
    document.getElementById('nav-store').addEventListener('click', () => showSection('store'));
    document.getElementById('nav-vault').addEventListener('click', () => showSection('vault'));
    document.getElementById('nav-orders').addEventListener('click', () => showSection('orders'));

    function showLogin() {
      document.getElementById('login-modal').classList.remove('hidden');
    }

    function hideLogin() {
      document.getElementById('login-modal').classList.add('hidden');
    }

    document.getElementById('close-login').addEventListener('click', hideLogin);

    // OTP flow
    document.getElementById('request-otp').addEventListener('click', async () => {
      const aadhaar = document.getElementById('aadhaar-input').value.trim();
      if (!aadhaar) return alert(translations[currentLang].enter_aadhaar);
      const res = await fetch(API_BASE + '/request-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ aadhaar }), credentials: 'same-origin' });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error');
      document.getElementById('otp-section').classList.remove('hidden');
      document.getElementById('verify-otp').classList.remove('hidden');
      if (j.devOtp) document.getElementById('otp-input').value = j.devOtp;
      alert('OTP requested');
    });

    document.getElementById('verify-otp').addEventListener('click', async () => {
      const aadhaar = document.getElementById('aadhaar-input').value.trim();
      const otp = document.getElementById('otp-input').value.trim();
      if (!aadhaar || !otp) return alert(translations[currentLang].enter_aadhaar_otp);
      const res = await fetch(API_BASE + '/verify-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ aadhaar, otp }), credentials: 'same-origin' });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error');
      if (j.token) localStorage.setItem(tokenKey, j.token);
      hideLogin();
      alert(translations[currentLang].login_success + (j.user && j.user.name));
      updateLoginState();
      showSection('store');
      loadStore();
      // Prompt for location after login (improves nearest-kendra info)
      try { requestAndSaveLocation(); } catch(e){ /* ignore */ }
    });

    function showSection(id) {
      document.getElementById('landing').classList.add('hidden');
      ['store','vault','orders'].forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'store') loadStore();
      if (id === 'vault') loadVault();
      if (id === 'orders') loadOrders();
    }

    // Cart Modal
    document.getElementById('view-cart-btn').addEventListener('click', () => {
      document.getElementById('cart-modal').classList.remove('hidden');
      renderCartModal();
    });

    document.getElementById('continue-shopping').addEventListener('click', () => {
      document.getElementById('cart-modal').classList.add('hidden');
    });

    function renderCartModal(){
      const list = document.getElementById('cart-items-list');
      list.innerHTML = '';
      if (CART.length === 0){
        list.innerHTML = '<div class="text-center py-8 text-slate-600">Your cart is empty</div>';
        return;
      }
      CART.forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
        el.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold">${item.name}</div>
            <div class="text-sm text-slate-600">‚Çπ${item.price} √ó ${item.quantity || 1} = ‚Çπ${item.price * (item.quantity || 1)}</div>
          </div>
          <button class="px-2 py-1 bg-slate-200 rounded remove-item" data-idx="${idx}">Remove</button>`;
        list.appendChild(el);
        el.querySelector('.remove-item').addEventListener('click', () => {
          CART.splice(idx, 1);
          saveCart();
          renderCartModal();
        });
      });
    }

    document.getElementById('checkout-btn').addEventListener('click', () => {
      if (CART.length === 0) return alert('Cart is empty');
      document.getElementById('cart-modal').classList.add('hidden');
      document.getElementById('checkout-modal').classList.remove('hidden');
    });

    // Checkout Modal
    document.getElementById('back-to-cart').addEventListener('click', () => {
      document.getElementById('checkout-modal').classList.add('hidden');
      document.getElementById('cart-modal').classList.remove('hidden');
    });

    document.getElementById('proceed-payment').addEventListener('click', () => {
      const name = document.getElementById('checkout-name').value.trim();
      const phone = document.getElementById('checkout-phone').value.trim();
      const address = document.getElementById('checkout-address').value.trim();
      if (!name || !phone || !address) return alert('Please fill all fields');
      if (!/^\d{10}$/.test(phone)) return alert('Please enter valid 10-digit phone number');
      
      checkoutData = { name, phone, address };
      document.getElementById('checkout-modal').classList.add('hidden');
      document.getElementById('payment-modal').classList.remove('hidden');
    });

    // Payment Gateway
    document.getElementById('cancel-payment').addEventListener('click', () => {
      document.getElementById('payment-modal').classList.add('hidden');
      document.getElementById('checkout-modal').classList.remove('hidden');
    });

    document.getElementById('pay-now').addEventListener('click', async () => {
      const cardNum = document.getElementById('card-number').value.trim();
      const expiry = document.getElementById('card-expiry').value.trim();
      const cvv = document.getElementById('card-cvv').value.trim();
      
      if (!cardNum || !expiry || !cvv) return alert('Please fill all card details');
      if (cardNum.replace(/\s/g, '').length < 13) return alert('Invalid card number');
      if (cvv.length < 3) return alert('Invalid CVV');

      const payBtn = document.getElementById('pay-now');
      payBtn.disabled = true;
      payBtn.textContent = 'Processing...';

      await new Promise(r => setTimeout(r, 2000));

      const token = localStorage.getItem(tokenKey);
      const total = CART.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
      
      const orderData = {
        items: CART,
        total: total,
        address: checkoutData.address,
        customerName: checkoutData.name,
        customerPhone: checkoutData.phone,
        paymentId: 'PAY_' + Math.random().toString(36).substr(2, 9).toUpperCase(),
        paymentStatus: 'completed'
      };

      const res = await fetch(API_BASE + '/orders', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify(orderData),
        credentials: 'same-origin'
      });

      const j = await res.json();
      
      if (res.ok){
        alert('Payment successful! Order #' + j.id + ' placed');
        CART = [];
        saveCart();
        document.getElementById('payment-modal').classList.add('hidden');
        document.getElementById('checkout-name').value = '';
        document.getElementById('checkout-phone').value = '';
        document.getElementById('checkout-address').value = '';
        document.getElementById('card-number').value = '';
        document.getElementById('card-expiry').value = '';
        document.getElementById('card-cvv').value = '';
        showSection('orders');
        loadOrders();
      } else {
        alert('Payment failed: ' + (j.error || 'Unknown error'));
      }

      payBtn.disabled = false;
      payBtn.textContent = 'Pay Now';
    });

    // Store
    async function loadStore(){
      const q = document.getElementById('store-search').value || '';
      const res = await fetch(API_BASE + '/medicines');
      const j = await res.json();
      const grid = document.getElementById('store-grid');
      grid.innerHTML = '';
      
      const meds = Array.isArray(j) ? j : (j.medicines || []);
      const filtered = q ? meds.filter(m => m.name.toLowerCase().includes(q.toLowerCase())) : meds;
      
      filtered.forEach(m => {
        const cartItem = CART.find(c => c.id === m.id);
        const qty = cartItem ? (cartItem.quantity || 1) : 0;
        
        const card = document.createElement('div');
        card.className = 'p-6 bg-white rounded-lg shadow hover:shadow-xl transition-all';
        card.innerHTML = `
          <div class="mb-4">
            <h4 class="font-bold text-lg">${m.name}</h4>
            <p class="text-xs text-teal-600 font-semibold">${m.company}</p>
          </div>
          <p class="text-sm text-slate-600 mb-4">${m.description || ''}</p>
          <div class="flex items-center justify-between pt-4 border-t">
            <div class="text-2xl font-bold text-teal-600">‚Çπ${m.price}</div>
            <div class="flex items-center gap-2">
              <button class="px-2 py-1 bg-slate-200 qty-minus" data-id="${m.id}" ${qty === 0 ? 'style="display:none"' : ''}>‚àí</button>
              <span class="w-8 text-center qty-display">${qty}</span>
              <button class="px-2 py-1 bg-amber-500 text-white qty-plus" data-id="${m.id}">+</button>
            </div>
          </div>`;
        grid.appendChild(card);

        card.querySelector('.qty-plus').addEventListener('click', () => {
          let item = CART.find(c => c.id === m.id);
          if (!item) {
            item = { ...m, quantity: 1 };
            CART.push(item);
          } else {
            item.quantity = (item.quantity || 1) + 1;
          }
          saveCart();
          loadStore();
        });

        const minusBtn = card.querySelector('.qty-minus');
        if (minusBtn){
          minusBtn.addEventListener('click', () => {
            let item = CART.find(c => c.id === m.id);
            if (item){
              item.quantity = Math.max(0, (item.quantity || 1) - 1);
              if (item.quantity === 0) CART = CART.filter(c => c.id !== m.id);
              saveCart();
              loadStore();
            }
          });
        }

        VanillaTilt.init(card, { max: 5, speed: 300 });
      });
    }

    // Search
    document.getElementById('store-search').addEventListener('input', () => loadStore());

    document.getElementById('search-btn').addEventListener('click', async () => {
      const q = document.getElementById('store-search').value.trim();
      if (!q) return alert('Enter a medicine name');
      
      const lowerQ = q.toLowerCase();
      const genericName = brandToGenericMap[lowerQ];
      
      if (genericName){
        document.getElementById('store-search').value = genericName;
      }
      loadStore();
    });

    // Vault
    async function loadVault(){
      checkAbhaStatus();
      const token = localStorage.getItem(tokenKey);
      const headers = token ? { Authorization: 'Bearer ' + token } : {};
      const res = await fetch(API_BASE + '/vault', { headers, credentials: 'same-origin' });
      const j = await res.json();
      const list = document.getElementById('vault-list');
      list.innerHTML = '';
      if (!j || j.length === 0){
        list.innerHTML = '<div class="p-6 bg-slate-50 rounded-lg text-center text-slate-600">No documents uploaded yet</div>';
        return;
      }
      j.forEach(d => {
        const el = document.createElement('div');
        el.className = 'p-6 bg-white rounded-lg shadow flex items-center justify-between';
        el.innerHTML = `
          <div>
            <div class="font-bold">${d.originalname}</div>
            <div class="text-sm text-slate-600">${new Date(d.uploadedAt).toLocaleDateString()}</div>
          </div>
          <button class="px-4 py-2 text-red-600 font-semibold delete-doc" data-id="${d.id}">Delete</button>`;
        list.appendChild(el);
        el.querySelector('.delete-doc').addEventListener('click', async () => {
          const res2 = await fetch(API_BASE + '/vault/' + d.id, { method: 'DELETE', headers, credentials: 'same-origin' });
          if (res2.ok) { alert('Deleted'); loadVault(); }
        });
      });
    }

    // Location helpers: request browser geolocation, reverse-geocode to city name
    async function requestAndSaveLocation(){
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        // store coordinates
        const loc = { lat, lon };
        localStorage.setItem('hn_location_coords', JSON.stringify(loc));
        // reverse geocode with Nominatim
        try {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
          const r = await fetch(url, { headers: { 'User-Agent': 'health-nexus-demo' } });
          const data = await r.json();
          const city = data.address && (data.address.city || data.address.town || data.address.village || data.address.county || data.address.state) || '';
          localStorage.setItem('hn_location_name', city || '');
          updateLocationUI();
        } catch (e) {
          localStorage.setItem('hn_location_name', '');
          updateLocationUI();
        }
      }, (err) => {
        // permission denied or error
        localStorage.removeItem('hn_location_coords');
        localStorage.removeItem('hn_location_name');
        updateLocationUI();
      }, { enableHighAccuracy: false, timeout: 10000 });
    }

    function updateLocationUI(){
      const name = localStorage.getItem('hn_location_name') || '';
      const locEl = document.getElementById('user-location');
      const nearestEl = document.getElementById('nearest-kendra');
      if (name){
        if (locEl) { locEl.textContent = name; locEl.classList.remove('hidden'); }
        if (nearestEl) { nearestEl.textContent = `Ordering by nearest Janaushadi Kendra in ${name}`; nearestEl.classList.remove('hidden'); }
      } else {
        if (locEl) locEl.classList.add('hidden');
        if (nearestEl) nearestEl.classList.add('hidden');
      }
    }

    // attempt to load saved location on init
    try { updateLocationUI(); } catch(e){}

    document.getElementById('upload-doc').addEventListener('click', async () => {
      if (!abhaVerified) return alert('Please verify your ABHA ID first');
      const file = document.getElementById('doc-file').files[0];
      if (!file) return alert('Select file');
      const token = localStorage.getItem(tokenKey);
      const headers = token ? { Authorization: 'Bearer ' + token } : {};
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch(API_BASE + '/vault', { method: 'POST', headers, body: fd, credentials: 'same-origin' });
      const j = await res.json();
      if (res.ok) {
        alert('Document uploaded');
        document.getElementById('doc-file').value = '';
        loadVault();
      } else {
        alert(j.error || 'Error');
      }
    });

    // Orders
    async function loadOrders(){
      const token = localStorage.getItem(tokenKey);
      const headers = token ? { Authorization: 'Bearer ' + token } : {};
      const res = await fetch(API_BASE + '/orders', { headers, credentials: 'same-origin' });
      const j = await res.json();
      const list = document.getElementById('orders-list');
      list.innerHTML = '';
      if (!j || j.length === 0){
        list.innerHTML = '<div class="p-6 bg-slate-50 rounded-lg text-center text-slate-600">No orders yet</div>';
        return;
      }

      // Sort recent orders first
      try { j.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); } catch(e){}

      j.forEach(o => {
        const daysAgo = Math.floor((Date.now() - new Date(o.createdAt).getTime()) / (1000 * 60 * 60 * 24));
        const status = daysAgo < 1 ? 'Processing' : daysAgo < 3 ? 'Shipped' : 'Delivered';
        const progress = daysAgo < 1 ? 25 : daysAgo < 3 ? 75 : 100;

        // Build a friendly title based on item names
        let title = '';
        if (o.items && o.items.length > 0){
          if (o.items.length === 1) title = o.items[0].name;
          else if (o.items.length === 2) title = o.items[0].name + ', ' + o.items[1].name;
          else title = o.items[0].name + ', ' + (o.items[1] ? o.items[1].name : '') + ', etc.';
        } else {
          title = 'Order';
        }

        const el = document.createElement('div');
        el.className = 'p-4 sm:p-6 bg-white rounded-lg shadow';
        el.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="font-bold text-lg">${title}</div>
              <div class="text-xs text-slate-600">Order #${o.id} ‚Ä¢ ${new Date(o.createdAt).toLocaleString()}</div>
              <div class="text-sm text-slate-500 mt-1">${o.items.length} items - ‚Çπ${o.total}</div>
            </div>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">${status}</span>
          </div>
          <div class="mb-3">
            <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-teal-600" style="width: ${progress}%"></div>
            </div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold track-order" data-id="${o.id}">Track</button>
            <button class="px-3 py-2 bg-slate-200 text-slate-800 rounded-lg text-sm font-semibold invoice-btn" data-id="${o.id}">Invoice</button>
          </div>`;
        list.appendChild(el);

        el.querySelector('.track-order').addEventListener('click', () => {
          alert(`${title}\nStatus: ${status}\nProgress: ${progress}%\nEstimated Delivery: ${new Date(new Date(o.createdAt).getTime() + 3*24*60*60*1000).toLocaleDateString()}`);
        });

        el.querySelector('.invoice-btn').addEventListener('click', () => {
          const html = `<html><body style="font-family:Arial"><h1>INVOICE</h1><p><b>Order:</b> ${o.id}</p><p><b>Date:</b> ${new Date(o.createdAt).toLocaleDateString()}</p><p><b>Customer:</b> ${o.customerName}</p><p><b>Address:</b> ${o.address}</p><table border="1" style="width:100%;border-collapse:collapse"><tr><th>Item</th><th>Qty</th><th>Price</th></tr>${o.items.map(i => `<tr><td>${i.name}</td><td>${i.quantity || 1}</td><td>‚Çπ${i.price}</td></tr>`).join('')}</table><p><b>Total: ‚Çπ${o.total}</b></p></body></html>`;
          const win = window.open('', '', 'width=800,height=600');
          win.document.write(html);
          win.print();
        });
      });
    }

    // Initialize
    updateLoginState();
    loadCart();
    // mobile cart button
    const mobileCartBtn = document.getElementById('mobile-cartBtn');
    if (mobileCartBtn){
      mobileCartBtn.addEventListener('click', () => { document.getElementById('cart-modal').classList.remove('hidden'); renderCartModal(); });
    }
    // keep mobile cart opacity in sync
    try { updateCartUI(); } catch(e){}
  </script>
</body>
</html>
